<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日外勤拜訪摘要 (含真實錄音功能)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* 自定義滾動條樣式 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #c7c7c7; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8; 
        }
        
        /* 錄音波紋動畫 */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .recording-pulse {
            animation: pulse-red 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 圖標組件 ---
        const IconWrapper = ({ icon, className, ...props }) => (
            <i className={`fa-solid ${icon} ${className}`} {...props}></i>
        );

        const ChevronLeft = (props) => <IconWrapper icon="fa-chevron-left" {...props} />;
        const ChevronRight = (props) => <IconWrapper icon="fa-chevron-right" {...props} />;
        const CalendarIcon = (props) => <IconWrapper icon="fa-calendar" {...props} />; 
        const Clock = (props) => <IconWrapper icon="fa-clock" {...props} />;
        const MapPin = (props) => <IconWrapper icon="fa-map-marker-alt" {...props} />;
        const MapIcon = (props) => <IconWrapper icon="fa-map" {...props} />;
        const X = (props) => <IconWrapper icon="fa-times" {...props} />;
        const Sparkles = (props) => <IconWrapper icon="fa-wand-magic-sparkles" {...props} />;
        const Loader2 = (props) => <IconWrapper icon="fa-spinner fa-spin" {...props} />;
        const User = (props) => <IconWrapper icon="fa-user" {...props} />;
        const CheckSquare = (props) => <IconWrapper icon="fa-check-square" {...props} />;
        const FileText = (props) => <IconWrapper icon="fa-file-lines" {...props} />;
        const Stethoscope = (props) => <IconWrapper icon="fa-stethoscope" {...props} />;
        const School = (props) => <IconWrapper icon="fa-graduation-cap" {...props} />;
        const Award = (props) => <IconWrapper icon="fa-award" {...props} />;
        const Smile = (props) => <IconWrapper icon="fa-face-smile" {...props} />;
        const Phone = (props) => <IconWrapper icon="fa-phone" {...props} />;
        const Users = (props) => <IconWrapper icon="fa-users" {...props} />;
        const ExternalLink = (props) => <IconWrapper icon="fa-up-right-from-square" {...props} />;
        const Mic = (props) => <IconWrapper icon="fa-microphone" {...props} />;
        const StopCircle = (props) => <IconWrapper icon="fa-stop-circle" {...props} />;
        const PlayCircle = (props) => <IconWrapper icon="fa-play-circle" {...props} />;
        const Trash = (props) => <IconWrapper icon="fa-trash-can" {...props} />;
        const ChevronDown = (props) => <IconWrapper icon="fa-chevron-down" {...props} />;

        // --- 可搜尋的下拉選單組件 ---
        const SearchableSelect = ({ options, placeholder, onSelect }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [query, setQuery] = useState("");
            const [selected, setSelected] = useState("");
            const wrapperRef = useRef(null);

            useEffect(() => {
                function handleClickOutside(event) {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);

            const filteredOptions = options.filter(option => 
                option.toLowerCase().includes(query.toLowerCase())
            );

            return (
                <div className="relative w-48" ref={wrapperRef} onClick={(e) => e.stopPropagation()}>
                    <div className="relative">
                        <input
                            type="text"
                            className="w-full border border-gray-300 rounded-md py-1 px-3 pr-8 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 text-gray-700 bg-white"
                            placeholder={placeholder}
                            value={isOpen ? query : (selected || query)}
                            onChange={(e) => {
                                setQuery(e.target.value);
                                setIsOpen(true);
                            }}
                            onFocus={() => {
                                setIsOpen(true);
                                if(selected) setQuery(""); 
                            }}
                        />
                        <div className="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none text-gray-400">
                            <ChevronDown className="w-3 h-3" />
                        </div>
                    </div>

                    {isOpen && (
                        <div className="absolute z-50 mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg max-h-48 overflow-y-auto">
                            {filteredOptions.length > 0 ? (
                                filteredOptions.map((option, index) => (
                                    <div
                                        key={index}
                                        className="px-3 py-2 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-700 cursor-pointer"
                                        onClick={() => {
                                            setSelected(option);
                                            setQuery(option);
                                            setIsOpen(false);
                                            if (onSelect) onSelect(option);
                                        }}
                                    >
                                        {option}
                                    </div>
                                ))
                            ) : (
                                <div className="px-3 py-2 text-sm text-gray-400">無符合項目</div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // --- 新增：真實錄音功能組件 ---
        const AudioRecorder = ({ title, themeColor, headerRight }) => {
            const [isRecording, setIsRecording] = useState(false);
            const [audioUrl, setAudioUrl] = useState(null);
            const [permissionError, setPermissionError] = useState(false);
            
            const mediaRecorderRef = useRef(null);
            const audioChunksRef = useRef([]);

            // 開始錄音
            const startRecording = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const mediaRecorder = new MediaRecorder(stream);
                    mediaRecorderRef.current = mediaRecorder;
                    audioChunksRef.current = [];

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunksRef.current.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/wav' });
                        const url = URL.createObjectURL(audioBlob);
                        setAudioUrl(url);
                        
                        // 停止所有音軌以釋放麥克風
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    setIsRecording(true);
                    setPermissionError(false);
                } catch (err) {
                    console.error("麥克風權限錯誤:", err);
                    setPermissionError(true);
                    alert("無法存取麥克風。請確認瀏覽器權限，並確保您是使用 https 或 localhost 開啟此頁面。");
                }
            };

            // 停止錄音
            const stopRecording = () => {
                if (mediaRecorderRef.current && isRecording) {
                    mediaRecorderRef.current.stop();
                    setIsRecording(false);
                }
            };

            // 刪除重錄
            const deleteRecording = (e) => {
                e.stopPropagation();
                setAudioUrl(null);
            };

            // 根據主題色設定樣式
            const themeStyles = {
                indigo: {
                    bar: "bg-indigo-500",
                    hoverBg: "hover:bg-indigo-50",
                    hoverBorder: "hover:border-indigo-200",
                    textGroup: "group-hover:text-indigo-500",
                    iconText: "text-indigo-500"
                },
                emerald: {
                    bar: "bg-emerald-500",
                    hoverBg: "hover:bg-emerald-50",
                    hoverBorder: "hover:border-emerald-200",
                    textGroup: "group-hover:text-emerald-500",
                    iconText: "text-emerald-500"
                }
            };
            const currentTheme = themeStyles[themeColor] || themeStyles.indigo;

            return (
                <div className="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex flex-col h-full overflow-visible">
                    <div className="flex items-center justify-between mb-3 relative z-10 h-8">
                        <h3 className="text-sm font-bold text-gray-600 flex items-center">
                            <span className={`w-1.5 h-6 ${currentTheme.bar} rounded-full mr-2`}></span>
                            {title}
                        </h3>
                        {headerRight}
                    </div>

                    <div 
                        onClick={!audioUrl ? (isRecording ? stopRecording : startRecording) : undefined}
                        className={`
                            flex-1 min-h-[140px] w-full flex flex-col items-center justify-center border-2 
                            rounded-lg transition-all relative
                            ${isRecording 
                                ? 'border-red-400 bg-red-50 cursor-pointer' 
                                : audioUrl 
                                    ? 'border-gray-300 bg-gray-50' 
                                    : `border-dashed border-gray-200 bg-gray-50 ${currentTheme.hoverBg} ${currentTheme.hoverBorder} cursor-pointer group`
                            }
                        `}
                    >
                        {/* 狀態 1: 正在錄音 */}
                        {isRecording && (
                            <>
                                <div className="w-16 h-16 rounded-full bg-red-500 flex items-center justify-center text-white mb-2 recording-pulse shadow-lg">
                                    <StopCircle className="text-3xl" />
                                </div>
                                <span className="text-sm font-bold text-red-500 animate-pulse">錄音中... 點擊停止</span>
                            </>
                        )}

                        {/* 狀態 2: 錄音完成 (顯示播放器) */}
                        {!isRecording && audioUrl && (
                            <div className="w-full px-4 flex flex-col items-center">
                                <div className="flex items-center gap-3 mb-3">
                                    <div className={`w-10 h-10 rounded-full bg-white shadow flex items-center justify-center ${currentTheme.iconText}`}>
                                        <CheckSquare className="text-xl" />
                                    </div>
                                    <span className="text-sm font-medium text-gray-700">錄音完成</span>
                                </div>
                                
                                <audio controls src={audioUrl} className="w-full h-8 mb-3" />
                                
                                <button 
                                    onClick={deleteRecording}
                                    className="px-3 py-1.5 text-xs text-red-500 hover:bg-red-50 rounded border border-red-200 flex items-center transition-colors"
                                >
                                    <Trash className="mr-1.5" /> 刪除並重新錄音
                                </button>
                            </div>
                        )}

                        {/* 狀態 3: 待機 (尚未錄音) */}
                        {!isRecording && !audioUrl && (
                            <>
                                <div className={`
                                    w-12 h-12 rounded-full bg-white shadow-sm flex items-center justify-center 
                                    ${currentTheme.iconText} group-hover:scale-110 transition-transform mb-2
                                `}>
                                    <Mic className="text-xl leading-none" />
                                </div>
                                <span className={`text-xs text-gray-400 font-medium ${currentTheme.textGroup}`}>
                                    {permissionError ? "無權限 (請檢查設定)" : "點擊開始錄音"}
                                </span>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        // --- 模擬產品資料 ---
        const PRODUCT_OPTIONS = [
            "A產品",
            "B產品",
            "C產品"
        ];

        // --- 主應用程式 ---
        const CalendarApp = () => {
            // 狀態管理
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(new Date());
            
            // 詳細資訊 Modal 狀態
            const [isDetailModalOpen, setIsDetailModalOpen] = useState(false);
            const [selectedEvent, setSelectedEvent] = useState(null);
            
            // AI 相關狀態
            const [isAIModalOpen, setIsAIModalOpen] = useState(false);
            const [aiPrompt, setAiPrompt] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);

            // 模擬當月數據 (全域)
            const currentMonthStats = {
                coverage: "85%",
                completion: "90%"
            };

            // 模擬行程數據
            const [events, setEvents] = useState([
                {
                id: 1,
                title: "【拜訪】陳醫師_P1_國立臺灣大學醫學院附設醫院",
                date: new Date(new Date().getFullYear(), new Date().getMonth(), 5),
                type: "work",
                time: "10:00 - 11:30",
                location: "診間 A"
                },
                {
                id: 2,
                title: "【拜訪】林醫師_P2_長庚醫院",
                date: new Date(new Date().getFullYear(), new Date().getMonth(), 12),
                type: "personal",
                time: "12:30 - 14:00",
                location: "診間 B"
                },
                {
                id: 3,
                title: "【拜訪】王醫師_P3_榮總",
                date: new Date(new Date().getFullYear(), new Date().getMonth(), 15),
                type: "important",
                time: "15:00 - 17:00",
                location: "手術室"
                },
                {
                id: 4,
                title: "【拜訪】張醫師_P4_馬偕醫院",
                date: new Date(new Date().getFullYear(), new Date().getMonth(), 24),
                type: "work",
                time: "14:00 - 16:00",
                location: "急診室"
                }
            ]);

            // 生成模擬詳細資料的輔助函式
            const getEventDetailData = (event) => {
                const parts = event.title.replace('【拜訪】', '').split('_');
                const doctorName = parts[0] || "未知醫師";
                const hospitalName = parts[2] || "未知醫院";
                const mapUrl = "https://www.google.com/maps/search/?api=1&query=" + encodeURIComponent(hospitalName);

                return {
                ...event,
                doctorInfo: {
                    name: doctorName,
                    hospital: hospitalName,
                    mapUrl: mapUrl,
                    visitType: " 產品推廣與學術溝通 / 面對面拜訪",
                    address: "台北市中正區中山南路7號",
                    department: "總醫師 / 內科 / 神經內科 / P1",
                    age: "男 / 52歲",
                    achievement: "是, 台灣內科醫學會 常務理事 / 是",
                    personality: "較不願意嘗試新藥 / 喜歡品紅酒",
                    phone: "02-23971920(4341) / 0987654321 / doctor@com.tw",
                    education: "國立台灣大學醫學系學士 / 美國約翰霍普金斯大學博士",
                    specialachievement: "協助成立台大醫院腦中風中心"
                },
                todos: [
                    "贈送中化禮品: 需先至土辦拿取禮品",
                    "詢問醫師開藥狀況",
                    "帶上一份最新的醫學期刊摘要"
                ],
                summary: {
                    lastVisit: "針對主力產品DEF，客戶回饋從不認同/反對轉為中立，但醫師仍對副作用數據有疑慮，需要更具公信力的證據",
                    salesSummary: "本季該醫院產品ABC銷量成長15%，銷售目標達成率 92%",
                    suggestion: "根據過往拜訪經驗，建議下次拜訪訂於下星期一下午診結束後（約16:30）",
                    prescriptionTrend: "產品:ABC 10KG/BAG / 階段:議價 / 預計完成日期:2025/01/31", 
                    promotionSuggestion: [
                        "NO.1: A產品: Key message: abc; 工具: def ...",
                        "NO.2: B產品: Key message: efficacy data; 工具: iPad detail aid",
                        "NO.3: C產品: Key message: safety profile; 工具: clinical paper"
                    ]
                }
                };
            };

            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const days = [];
                for (let i = 0; i < firstDayOfMonth; i++) {
                    const prevDate = new Date(year, month, 0 - i);
                    days.unshift({ date: prevDate, isCurrentMonth: false });
                }
                for (let i = 1; i <= daysInMonth; i++) {
                    days.push({ date: new Date(year, month, i), isCurrentMonth: true });
                }
                const remainingCells = 42 - days.length;
                for (let i = 1; i <= remainingCells; i++) {
                    days.push({ date: new Date(year, month + 1, i), isCurrentMonth: false });
                }
                return days;
            };

            const isSameDay = (d1, d2) => d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
            const isToday = (date) => isSameDay(date, new Date());
            const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));

            const handleEventClick = (e, event) => {
                e.stopPropagation();
                const detailData = getEventDetailData(event);
                setSelectedEvent(detailData);
                setIsDetailModalOpen(true);
            };

            // Gemini AI 行程生成 (僅保留邏輯，隱藏UI)
            const handleAIGenerate = async () => {
                if (!aiPrompt.trim()) return;
                setIsGenerating(true);
                const apiKey = ""; 
                try {
                const systemPrompt = `You are a calendar assistant. Return JSON.`;
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: aiPrompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                    }
                );
                const data = await response.json();
                if (data.candidates && data.candidates[0].content) {
                    const result = JSON.parse(data.candidates[0].content.parts[0].text);
                    const aiEvent = {
                        id: Date.now(),
                        title: result.title,
                        date: new Date(result.date),
                        type: result.type,
                        time: result.time,
                        location: result.location
                    };
                    setEvents([...events, aiEvent]);
                    setCurrentDate(new Date(result.date));
                    setSelectedDate(new Date(result.date));
                    setAiPrompt('');
                    setIsAIModalOpen(false);
                }
                } catch (error) {
                    console.error("AI Error:", error);
                    alert("AI 請求失敗");
                } finally {
                    setIsGenerating(false);
                }
            };

            const calendarDays = getDaysInMonth(currentDate);
            const typeColors = {
                work: "bg-gray-100 text-gray-700 border-gray-200 hover:bg-gray-200",
                personal: "bg-gray-100 text-gray-700 border-gray-200 hover:bg-gray-200",
                important: "bg-gray-100 text-gray-700 border-gray-200 hover:bg-gray-200",
            };

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans selection:bg-indigo-100">
                <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div className="flex flex-col gap-8">
                    <div className="flex-1 bg-white rounded-3xl shadow-sm border border-gray-200 overflow-hidden flex flex-col h-[800px]">
                        <div className="p-6 border-b border-gray-100 flex items-center justify-between">
                            <div className="flex items-center space-x-4">
                                <h2 className="text-2xl font-bold text-gray-900">
                                {currentDate.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long' })}
                                </h2>
                                <div className="flex items-center bg-gray-100 rounded-lg p-1">
                                    <button onClick={prevMonth} className="p-1 hover:bg-white hover:shadow-sm rounded-md transition-all text-gray-600">
                                        <ChevronLeft className="w-5 h-5" />
                                    </button>
                                    <button onClick={nextMonth} className="p-1 hover:bg-white hover:shadow-sm rounded-md transition-all text-gray-600">
                                        <ChevronRight className="w-5 h-5" />
                                    </button>
                                </div>
                            </div>

                            <div className="flex items-center space-x-3 hidden md:flex">
                                <div className="px-4 py-2 bg-gray-100 rounded-xl border border-gray-200 min-w-[120px]">
                                    <p className="text-[10px] text-gray-500 font-bold uppercase tracking-wider">本月拜訪涵蓋率</p>
                                    <p className="text-lg font-bold text-gray-900 leading-none mt-0.5">{currentMonthStats.coverage}</p>
                                </div>
                                
                                <div className="px-4 py-2 bg-gray-100 rounded-xl border border-gray-200 min-w-[120px]">
                                    <p className="text-[10px] text-gray-500 font-bold uppercase tracking-wider">完成率</p>
                                    <p className="text-lg font-bold text-gray-900 leading-none mt-0.5">{currentMonthStats.completion}</p>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-7 border-b border-gray-100 bg-gray-50/50">
                        {['日', '一', '二', '三', '四', '五', '六'].map((day, idx) => (
                            <div key={day} className={`py-3 text-center text-xs font-semibold uppercase tracking-widest ${idx === 0 || idx === 6 ? 'text-indigo-400' : 'text-gray-400'}`}>
                            {day}
                            </div>
                        ))}
                        </div>

                        <div className="grid grid-cols-7 grid-rows-6 flex-1">
                        {calendarDays.map((item, index) => {
                            const dayEvents = events.filter(e => isSameDay(e.date, item.date));
                            const isSelected = isSameDay(item.date, selectedDate);
                            const isCurrentDay = isToday(item.date);
                            
                            return (
                            <div 
                                key={index}
                                onClick={() => setSelectedDate(item.date)}
                                className={`
                                relative border-b border-r border-gray-100 p-2 transition-all cursor-pointer group hover:bg-gray-50
                                ${!item.isCurrentMonth ? 'bg-gray-50/30' : 'bg-white'}
                                ${isSelected ? 'ring-2 ring-indigo-500 ring-inset z-10' : ''}
                                `}
                            >
                                <div className="flex justify-between items-start">
                                <span className={`
                                    w-7 h-7 flex items-center justify-center rounded-full text-sm font-medium transition-colors
                                    ${isCurrentDay 
                                    ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' 
                                    : item.isCurrentMonth ? 'text-gray-700' : 'text-gray-300'}
                                `}>
                                    {item.date.getDate()}
                                </span>
                                </div>

                                <div className="mt-2 space-y-1">
                                {dayEvents.slice(0, 4).map((event) => (
                                    <div 
                                    key={event.id}
                                    onClick={(e) => handleEventClick(e, event)}
                                    className={`
                                        px-1.5 py-1 rounded text-[10px] font-medium border-l-2 flex flex-col items-start overflow-hidden cursor-pointer shadow-sm transition-all hover:shadow-md
                                        ${typeColors[event.type]}
                                    `}
                                    >
                                    <span className="text-[9px] opacity-80 mb-0.5 leading-none">
                                        {event.time.split(' - ')[0]}
                                    </span>
                                    <span className="truncate w-full leading-tight">
                                        {event.title}
                                    </span>
                                    </div>
                                ))}
                                {dayEvents.length > 4 && (
                                    <div className="text-[10px] text-gray-400 pl-1">
                                    還有 {dayEvents.length - 4} 個行程...
                                    </div>
                                )}
                                </div>
                            </div>
                            );
                        })}
                        </div>
                    </div>
                    </div>
                </main>

                {isDetailModalOpen && selectedEvent && (
                    <div className="fixed inset-0 z-50 overflow-y-auto" role="dialog">
                    <div className="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                        <div className="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm" onClick={() => setIsDetailModalOpen(false)}></div>
                        <span className="hidden sm:inline-block sm:align-middle sm:h-screen">​</span>
                        
                        <div className="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl w-full">
                        
                        <div className="relative bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-6">
                            <button onClick={() => setIsDetailModalOpen(false)} className="absolute top-4 right-4 text-white/70 hover:text-white transition-colors">
                            <X className="w-6 h-6" />
                            </button>
                            <div className="text-white">
                            <div className="flex items-center space-x-2 text-indigo-100 text-sm font-medium mb-1">
                                <CalendarIcon className="w-4 h-4" />
                                <span>
                                {selectedEvent.date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}
                                </span>
                                <span className="mx-1">•</span>
                                <Clock className="w-4 h-4" />
                                <span>{selectedEvent.time}</span>
                            </div>
                            <h2 className="text-2xl font-bold tracking-tight mt-1">{selectedEvent.title}</h2>
                            </div>
                        </div>

                        <div className="p-6 space-y-6 bg-gray-50/50">
                            
                            {/* 基本資訊 */}
                            <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
                            <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 flex items-center">
                                <User className="w-4 h-4 mr-2" /> 基本資訊
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-y-4 gap-x-6">
                                <div className="flex items-start">
                                <div className="p-2 bg-blue-50 text-blue-600 rounded-lg mr-3"><Users className="w-4 h-4" /></div>
                                <div>
                                    <p className="text-xs text-gray-500">拜訪目的 / 類型</p>
                                    <p className="text-sm font-medium text-gray-900">{selectedEvent.doctorInfo.visitType}</p>
                                </div>
                                </div>
                                <div className="flex items-start">
                                <div className="p-2 bg-blue-50 text-blue-600 rounded-lg mr-3"><Stethoscope className="w-4 h-4" /></div>
                                <div>
                                    <p className="text-xs text-gray-500">醫師 / 職稱 / 部門</p>
                                    <p className="text-sm font-medium text-gray-900">{selectedEvent.doctorInfo.name} / {selectedEvent.doctorInfo.department}</p>
                                </div>
                                </div>
                                <div className="flex items-start">
                                <div className="p-2 bg-blue-50 text-blue-600 rounded-lg mr-3"><MapPin className="w-4 h-4" /></div>
                                <div>
                                    <p className="text-xs text-gray-500">客戶</p>
                                    <p className="text-sm font-medium text-gray-900">{selectedEvent.doctorInfo.hospital}</p>
                                    <a href={selectedEvent.doctorInfo.mapUrl} target="_blank" className="inline-flex items-center mt-1.5 text-xs text-indigo-600 hover:text-indigo-800 hover:underline">
                                    <MapIcon className="w-3 h-3 mr-1" />
                                    Google 地圖
                                    </a>
                                </div>
                                </div>
                                {/* 更多基本資訊 (省略重複結構以節省空間，功能與上版相同) */}
                            </div>
                            </div>

                            {/* 待辦任務 */}
                            <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
                            <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 flex items-center">
                                <CheckSquare className="w-4 h-4 mr-2" /> 待辦任務
                            </h3>
                            <ul className="space-y-2 list-disc pl-5 text-sm text-gray-700">
                                {selectedEvent.todos.map((todo, idx) => (
                                <li key={idx} className="pl-1">{todo}</li>
                                ))}
                            </ul>
                            </div>

                            {/* 數據與摘要 (含三欄產品推廣) */}
                            <div className="bg-white rounded-xl p-5 shadow-sm border border-gray-100">
                            <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 flex items-center">
                                <FileText className="w-4 h-4 mr-2" /> 數據與摘要
                            </h3>
                            <div className="space-y-4 text-sm text-gray-600">
                                <div className="bg-gray-50 p-3 rounded-lg space-y-2">
                                    <p className="flex gap-2">
                                        <span className="font-semibold text-gray-800 flex-shrink-0 w-20">近期拜訪：</span> 
                                        <span>{selectedEvent.summary.lastVisit}</span>
                                    </p>
                                    <p className="flex gap-2">
                                        <span className="font-semibold text-gray-800 flex-shrink-0 w-20">銷售摘要：</span> 
                                        <span>{selectedEvent.summary.salesSummary}</span>
                                    </p>
                                </div>
                                <div className="grid grid-cols-1 gap-2 px-1">
                                    <p className="flex gap-2 items-start">
                                        <span className="font-semibold text-gray-800 flex-shrink-0 w-20">相關機會：</span> 
                                        <span>{selectedEvent.summary.prescriptionTrend}</span>
                                    </p>
                                    <div className="flex gap-2 items-start">
                                        <span className="font-semibold text-gray-800 flex-shrink-0 w-20 pt-0.5">產品推廣：</span> 
                                        <div className="flex flex-col space-y-1">
                                            {Array.isArray(selectedEvent.summary.promotionSuggestion) 
                                                ? selectedEvent.summary.promotionSuggestion.map((item, index) => (
                                                    <span key={index}>{item}</span>
                                                ))
                                                : <span>{selectedEvent.summary.promotionSuggestion}</span>
                                            }
                                        </div>
                                    </div>
                                    <p className="flex gap-2 items-start">
                                        <span className="font-semibold text-gray-800 flex-shrink-0 w-20">AI 建議：</span> 
                                        <span>{selectedEvent.summary.suggestion}</span>
                                    </p>
                                </div>
                            </div>
                            </div>

                            {/* 區塊 5: 真實錄音功能區 */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
                                {/* 左側：產品反饋錄音 */}
                                <AudioRecorder 
                                    title="產品反饋" 
                                    themeColor="indigo"
                                    headerRight={
                                        <SearchableSelect 
                                            options={PRODUCT_OPTIONS} 
                                            placeholder="搜尋產品..." 
                                            onSelect={(val) => console.log("Selected:", val)} 
                                        />
                                    }
                                />

                                {/* 右側：訪談反饋錄音 */}
                                <AudioRecorder 
                                    title="訪談反饋" 
                                    themeColor="emerald"
                                />
                            </div>

                        </div>
                        </div>
                    </div>
                    </div>
                )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<CalendarApp />);
    </script>
</body>
</html>